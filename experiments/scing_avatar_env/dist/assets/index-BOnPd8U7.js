var yt=Object.defineProperty;var Ft=(i,t,r)=>t in i?yt(i,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):i[t]=r;var w=(i,t,r)=>Ft(i,typeof t!="symbol"?t+"":t,r);import{g as At}from"./index-D-9gGu6L.js";function b(i){if(this.size=i|0,this.size<=1||this.size&this.size-1)throw new Error("FFT size must be a power of two and bigger than 1");this._csize=i<<1;for(var t=new Array(this.size*2),r=0;r<t.length;r+=2){const c=Math.PI*r/this.size;t[r]=Math.cos(c),t[r+1]=-Math.sin(c)}this.table=t;for(var n=0,s=1;this.size>s;s<<=1)n++;this._width=n%2===0?n-1:n,this._bitrev=new Array(1<<this._width);for(var e=0;e<this._bitrev.length;e++){this._bitrev[e]=0;for(var o=0;o<this._width;o+=2){var a=this._width-o-2;this._bitrev[e]|=(e>>>o&3)<<a}}this._out=null,this._data=null,this._inv=0}var Tt=b;b.prototype.fromComplexArray=function(t,r){for(var n=r||new Array(t.length>>>1),s=0;s<t.length;s+=2)n[s>>>1]=t[s];return n};b.prototype.createComplexArray=function(){const t=new Array(this._csize);for(var r=0;r<t.length;r++)t[r]=0;return t};b.prototype.toComplexArray=function(t,r){for(var n=r||this.createComplexArray(),s=0;s<n.length;s+=2)n[s]=t[s>>>1],n[s+1]=0;return n};b.prototype.completeSpectrum=function(t){for(var r=this._csize,n=r>>>1,s=2;s<n;s+=2)t[r-s]=t[s],t[r-s+1]=-t[s+1]};b.prototype.transform=function(t,r){if(t===r)throw new Error("Input and output buffers must be different");this._out=t,this._data=r,this._inv=0,this._transform4(),this._out=null,this._data=null};b.prototype.realTransform=function(t,r){if(t===r)throw new Error("Input and output buffers must be different");this._out=t,this._data=r,this._inv=0,this._realTransform4(),this._out=null,this._data=null};b.prototype.inverseTransform=function(t,r){if(t===r)throw new Error("Input and output buffers must be different");this._out=t,this._data=r,this._inv=1,this._transform4();for(var n=0;n<t.length;n++)t[n]/=this.size;this._out=null,this._data=null};b.prototype._transform4=function(){var t=this._out,r=this._csize,n=this._width,s=1<<n,e=r/s<<1,o,a,c=this._bitrev;if(e===4)for(o=0,a=0;o<r;o+=e,a++){const l=c[a];this._singleTransform2(o,l,s)}else for(o=0,a=0;o<r;o+=e,a++){const l=c[a];this._singleTransform4(o,l,s)}var h=this._inv?-1:1,f=this.table;for(s>>=2;s>=2;s>>=2){e=r/s<<1;var _=e>>>2;for(o=0;o<r;o+=e)for(var v=o+_,g=o,u=0;g<v;g+=2,u+=s){const l=g,m=l+_,d=m+_,p=d+_,F=t[l],T=t[l+1],A=t[m],y=t[m+1],B=t[d],I=t[d+1],x=t[p],z=t[p+1],R=F,M=T,C=f[u],E=h*f[u+1],V=A*C-y*E,D=A*E+y*C,P=f[2*u],G=h*f[2*u+1],H=B*P-I*G,J=B*G+I*P,Q=f[3*u],U=h*f[3*u+1],W=x*Q-z*U,X=x*U+z*Q,Y=R+H,S=M+J,N=R-H,Z=M-J,j=V+W,$=D+X,K=h*(V-W),L=h*(D-X),k=Y+j,tt=S+$,rt=Y-j,st=S-$,nt=N+L,et=Z-K,ot=N-L,it=Z+K;t[l]=k,t[l+1]=tt,t[m]=nt,t[m+1]=et,t[d]=rt,t[d+1]=st,t[p]=ot,t[p+1]=it}}};b.prototype._singleTransform2=function(t,r,n){const s=this._out,e=this._data,o=e[r],a=e[r+1],c=e[r+n],h=e[r+n+1],f=o+c,_=a+h,v=o-c,g=a-h;s[t]=f,s[t+1]=_,s[t+2]=v,s[t+3]=g};b.prototype._singleTransform4=function(t,r,n){const s=this._out,e=this._data,o=this._inv?-1:1,a=n*2,c=n*3,h=e[r],f=e[r+1],_=e[r+n],v=e[r+n+1],g=e[r+a],u=e[r+a+1],l=e[r+c],m=e[r+c+1],d=h+g,p=f+u,F=h-g,T=f-u,A=_+l,y=v+m,B=o*(_-l),I=o*(v-m),x=d+A,z=p+y,R=F+I,M=T-B,C=d-A,E=p-y,V=F-I,D=T+B;s[t]=x,s[t+1]=z,s[t+2]=R,s[t+3]=M,s[t+4]=C,s[t+5]=E,s[t+6]=V,s[t+7]=D};b.prototype._realTransform4=function(){var t=this._out,r=this._csize,n=this._width,s=1<<n,e=r/s<<1,o,a,c=this._bitrev;if(e===4)for(o=0,a=0;o<r;o+=e,a++){const at=c[a];this._singleRealTransform2(o,at>>>1,s>>>1)}else for(o=0,a=0;o<r;o+=e,a++){const at=c[a];this._singleRealTransform4(o,at>>>1,s>>>1)}var h=this._inv?-1:1,f=this.table;for(s>>=2;s>=2;s>>=2){e=r/s<<1;var _=e>>>1,v=_>>>1,g=v>>>1;for(o=0;o<r;o+=e)for(var u=0,l=0;u<=g;u+=2,l+=s){var m=o+u,d=m+v,p=d+v,F=p+v,T=t[m],A=t[m+1],y=t[d],B=t[d+1],I=t[p],x=t[p+1],z=t[F],R=t[F+1],M=T,C=A,E=f[l],V=h*f[l+1],D=y*E-B*V,P=y*V+B*E,G=f[2*l],H=h*f[2*l+1],J=I*G-x*H,Q=I*H+x*G,U=f[3*l],W=h*f[3*l+1],X=z*U-R*W,Y=z*W+R*U,S=M+J,N=C+Q,Z=M-J,j=C-Q,$=D+X,K=P+Y,L=h*(D-X),k=h*(P-Y),tt=S+$,rt=N+K,st=Z+k,nt=j-L;if(t[m]=tt,t[m+1]=rt,t[d]=st,t[d+1]=nt,u===0){var et=S-$,ot=N-K;t[p]=et,t[p+1]=ot;continue}if(u!==g){var it=Z,ft=-j,lt=S,ut=-N,_t=-h*k,vt=-h*L,mt=-h*K,dt=-h*$,pt=it+_t,gt=ft+vt,bt=lt+dt,wt=ut-mt,ht=o+v-u,ct=o+_-u;t[ht]=pt,t[ht+1]=gt,t[ct]=bt,t[ct+1]=wt}}}};b.prototype._singleRealTransform2=function(t,r,n){const s=this._out,e=this._data,o=e[r],a=e[r+n],c=o+a,h=o-a;s[t]=c,s[t+1]=0,s[t+2]=h,s[t+3]=0};b.prototype._singleRealTransform4=function(t,r,n){const s=this._out,e=this._data,o=this._inv?-1:1,a=n*2,c=n*3,h=e[r],f=e[r+n],_=e[r+a],v=e[r+c],g=h+_,u=h-_,l=f+v,m=o*(f-v),d=g+l,p=u,F=-m,T=g-l,A=u,y=m;s[t]=d,s[t+1]=0,s[t+2]=p,s[t+3]=F,s[t+4]=T,s[t+5]=0,s[t+6]=A,s[t+7]=y};const Bt=At(Tt);class q{constructor(t,r){w(this,"_inputLength");w(this,"_fft");w(this,"_bufferSupplier");w(this,"_paddedInputBuffer");w(this,"_transformBuffer");w(this,"_inverseBuffer");if(t<1)throw new Error("Input length must be at least one");this._inputLength=t,this._fft=new Bt(zt(2*t)),this._bufferSupplier=r,this._paddedInputBuffer=this._bufferSupplier(this._fft.size),this._transformBuffer=this._bufferSupplier(2*this._fft.size),this._inverseBuffer=this._bufferSupplier(2*this._fft.size)}static forFloat32Array(t){return new q(t,r=>new Float32Array(r))}static forFloat64Array(t){return new q(t,r=>new Float64Array(r))}static forNumberArray(t){return new q(t,r=>Array(r))}get inputLength(){return this._inputLength}autocorrelate(t,r=this._bufferSupplier(t.length)){if(t.length!==this._inputLength)throw new Error(`Input must have length ${this._inputLength} but had length ${t.length}`);for(let s=0;s<t.length;s++)this._paddedInputBuffer[s]=t[s];for(let s=t.length;s<this._paddedInputBuffer.length;s++)this._paddedInputBuffer[s]=0;this._fft.realTransform(this._transformBuffer,this._paddedInputBuffer),this._fft.completeSpectrum(this._transformBuffer);const n=this._transformBuffer;for(let s=0;s<n.length;s+=2)n[s]=n[s]*n[s]+n[s+1]*n[s+1],n[s+1]=0;this._fft.inverseTransform(this._inverseBuffer,this._transformBuffer);for(let s=0;s<t.length;s++)r[s]=this._inverseBuffer[2*s];return r}}function It(i){const t=[];let r=!1,n=-1/0,s=-1;for(let e=1;e<i.length-1;e++)i[e-1]<=0&&i[e]>0?(r=!0,s=e,n=i[e]):i[e-1]>0&&i[e]<=0?(r=!1,s!==-1&&t.push(s)):r&&i[e]>n&&(n=i[e],s=e);return t}function xt(i,t){const[r,n,s]=[i-1,i,i+1],[e,o,a]=[t[r],t[n],t[s]],c=e/2-o+a/2,h=-(e/2)*(n+s)+o*(r+s)-a/2*(r+n),f=e*n*s/2-o*r*s+a*r*n/2,_=-h/(2*c),v=c*_*_+h*_+f;return[_,v]}class O{constructor(t,r){w(this,"_autocorrelator");w(this,"_nsdfBuffer");w(this,"_clarityThreshold",.9);w(this,"_minVolumeAbsolute",0);w(this,"_maxInputAmplitude",1);this._autocorrelator=new q(t,r),this._nsdfBuffer=r(t)}static forFloat32Array(t){return new O(t,r=>new Float32Array(r))}static forFloat64Array(t){return new O(t,r=>new Float64Array(r))}static forNumberArray(t){return new O(t,r=>Array(r))}get inputLength(){return this._autocorrelator.inputLength}set clarityThreshold(t){if(!Number.isFinite(t)||t<=0||t>1)throw new Error("clarityThreshold must be a number in the range (0, 1]");this._clarityThreshold=t}set minVolumeAbsolute(t){if(!Number.isFinite(t)||t<0||t>this._maxInputAmplitude)throw new Error(`minVolumeAbsolute must be a number in the range [0, ${this._maxInputAmplitude}]`);this._minVolumeAbsolute=t}set minVolumeDecibels(t){if(!Number.isFinite(t)||t>0)throw new Error("minVolumeDecibels must be a number <= 0");this._minVolumeAbsolute=this._maxInputAmplitude*10**(t/10)}set maxInputAmplitude(t){if(!Number.isFinite(t)||t<=0)throw new Error("maxInputAmplitude must be a number > 0");this._maxInputAmplitude=t}findPitch(t,r){if(this._belowMinimumVolume(t))return[0,0];this._nsdf(t);const n=It(this._nsdfBuffer);if(n.length===0)return[0,0];const s=Math.max(...n.map(c=>this._nsdfBuffer[c])),e=n.find(c=>this._nsdfBuffer[c]>=this._clarityThreshold*s),[o,a]=xt(e,this._nsdfBuffer);return[r/o,Math.min(a,1)]}_belowMinimumVolume(t){if(this._minVolumeAbsolute===0)return!1;let r=0;for(let n=0;n<t.length;n++)r+=t[n]**2;return Math.sqrt(r/t.length)<this._minVolumeAbsolute}_nsdf(t){this._autocorrelator.autocorrelate(t,this._nsdfBuffer);let r=2*this._nsdfBuffer[0],n;for(n=0;n<this._nsdfBuffer.length&&r>0;n++)this._nsdfBuffer[n]=2*this._nsdfBuffer[n]/r,r-=t[n]**2+t[t.length-n-1]**2;for(;n<this._nsdfBuffer.length;n++)this._nsdfBuffer[n]=0}}function zt(i){return i--,i|=i>>1,i|=i>>2,i|=i>>4,i|=i>>8,i|=i>>16,i++,i}export{q as Autocorrelator,O as PitchDetector};
