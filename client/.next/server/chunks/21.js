"use strict";exports.id=21,exports.ids=[21],exports.modules={2021:(a,b,c)=>{let d,e,f;c.d(b,{I:()=>P});var g=c(7598),h=c.n(g);let i={bane_fog_v1:{id:"bane_fog_v1",name:"BANE Fear-of-God Mode",version:"1.0.0",rulesetId:"fog-core",defaults:{defaultVerdict:"deny",strictMode:!0,escalationEnabled:!0,quarantineOnDeny:!0,lockoutOnRepeat:!0,incidentOnCritical:!0}}};function j(a){let b=(i[a?.trim()||"bane_fog_v1"]??i.bane_fog_v1).defaults;return{strictMode:b.strictMode,defaultVerdict:"deny"===b.defaultVerdict?"deny":"allow",escalationEnabled:b.escalationEnabled,quarantineOnDeny:b.quarantineOnDeny,lockoutOnRepeat:b.lockoutOnRepeat,incidentOnCritical:b.incidentOnCritical}}function k(a){return{id:a.id,title:a.title,severity:a.severity,verdict:a.verdict,rationale:a.rationale,tags:a.tags,evidence:a.evidence}}function l(a){return(a.text||"").toLowerCase()}function m(a,b){return b.some(b=>a.includes(b))}let n=["ignore previous","system prompt","developer message","override policy","bypass","jailbreak","disable safety","act as"],o=["api key","secret","token","password","credentials","private key","dump"],p=["malware","ransomware","keylogger","exploit","payload","backdoor"],q=["admin","elevate privilege","root access","operator mode","policy admin"],r={low:1,medium:2,high:3,critical:4},s={allow:1,sanitize:2,review:3,deny:4},t={low:1,medium:2,high:3,critical:4},u={allow:1,sanitize:2,review:3,deny:4};function v(a){return[...a].sort((a,b)=>{let c=t[b.severity]-t[a.severity];if(0!==c)return c;let d=u[b.verdict]-u[a.verdict];return 0!==d?d:a.id.localeCompare(b.id)})}let w=new Map;function x(a,b,c=Date.now()){let d=w.get(a)??{identityId:a,strikes:0,lastSeverity:"high",lastSeen:c};d.lockedUntil=c+Math.max(0,b),w.set(a,d)}let y=new Map;function z(a){return{verdict:"deny",severity:"high",findings:[{id:a.id,title:a.title,severity:"high",verdict:"deny",rationale:a.rationale,tags:["preflight"]}],traceId:a.traceId,timingMs:a.timingMs,enforcementLevel:a.enforcementLevel,publicMessage:a.message}}let A=new Map;function B(a,b){return a?`id:${a}`:b?`ip:${b}`:"anon"}function C(a){let b=a.now??Date.now(),c=B(a.identityId,a.ipHash),d=A.get(c),e={strikes:(d?.strikes??0)+1,lastAt:b};return A.set(c,e),e}function D(a){let b=a.now??Date.now(),c=B(a.identityId,a.ipHash),d=A.get(c);if(!d)return{action:"none"};let e=Math.min(250*Math.pow(2,Math.max(0,d.strikes-1)),8e3);return b-d.lastAt<250&&d.strikes>=3?{action:"block",retryAfterMs:15e3}:e>=500?{action:"delay",delayMs:e}:{action:"none"}}let E=["system prompt","developer message","detector","regex","pattern","rule","threshold","internal","policy id"];function F(a){return a.publicMessage&&(a.publicMessage=function(a){let b=a.toLowerCase();for(let a of E)if(b.includes(a))return"Request denied by security policy. This attempt has been logged.";return a}(a.publicMessage)),a}function G(a){return h().createHash("sha256").update(a).digest("hex")}function H(a,b,c){try{let d=a.store;if(d){let a,e,f=(a=b.text??"",e=c.safeText,{at:Date.now(),traceId:c.traceId,route:String(b.req?.route??"unknown"),requiredCapability:b.req?.requiredCapability,identityId:b.req?.auth?.identityId,verdict:c.verdict,severity:c.severity,enforcementLevel:c.enforcementLevel,inputHash:G(a),safeTextHash:"string"==typeof e?G(e):void 0,findingsSummary:(c.findings??[]).map(a=>({id:a.id,severity:a.severity,verdict:a.verdict}))});d.appendAudit(f).catch(()=>{}),d.appendEvent({type:"BANE_DECISION",traceId:c.traceId,at:Date.now(),data:{verdict:c.verdict,severity:c.severity,enforcementLevel:c.enforcementLevel}}).catch(()=>{})}}catch{}}function I(a){let b=j(a.profileId);return{evaluate(c){var d,e,f;let g,i,t=Date.now(),u="function"==typeof h().randomUUID?h().randomUUID():h().randomBytes(16).toString("hex"),A=(g=(c.text??"").replace(/\s+/g," ").trim().toLowerCase(),{original:c,forDetection:{...c,text:g}}),B=function(a,b,c,d){let e=j(a.profileId);0;let f=b.req?.auth,g=b.req?.requiredCapability;if(!f?.identityId)return z({traceId:c,enforcementLevel:2,message:"Request denied: unauthorized or unsafe operation. This attempt has been logged.",id:"NO_AUTH",title:"Authentication missing",rationale:"No authenticated identity was provided.",timingMs:Date.now()-d});let h=function(a){let b=a.req?.auth,c=b?.nonce,d=Date.now();if(c){let a=y.get(c);if(a&&d-a<6e5)return{ok:!1,code:"REPLAY"};if(y.set(c,d),y.size>1e4){let a=y.keys().next().value;a&&y.delete(a)}}return{ok:!0}}(b);if(!1===h.ok&&"REPLAY"===h.code)return z({traceId:c,enforcementLevel:4,message:"Access revoked temporarily due to policy violations. Contact an authorized administrator.",id:"REPLAY_DETECTED",title:"Replay detected",rationale:"Request nonce has been seen recently.",timingMs:Date.now()-d});if(function(a,b=Date.now()){let c=w.get(a);return!!c?.lockedUntil&&b<c.lockedUntil}(f.identityId))return{verdict:"deny",severity:"high",findings:[{id:"IDENTITY_LOCKED",title:"Identity temporarily locked",severity:"high",verdict:"deny",rationale:"Prior violations triggered an automatic lockout.",tags:["lockout","preflight"]}],traceId:c,timingMs:Date.now()-d,enforcementLevel:4,publicMessage:"Access revoked temporarily due to policy violations. Contact an authorized administrator."};if(g&&!(Array.isArray(f.capabilities)?f.capabilities:[]).includes(g))return z({traceId:c,enforcementLevel:3,message:"Request denied: unauthorized or unsafe operation. This attempt has been logged.",id:"MISSING_CAPABILITY",title:"Insufficient capability",rationale:"Authenticated identity lacks required capability.",timingMs:Date.now()-d});if(e.strictMode){let a=f.sessionIntegrity;if(!(a?.nonceOk&&a?.signatureOk&&a?.tokenFresh))return z({traceId:c,enforcementLevel:3,message:"Request denied: unauthorized or unsafe operation. This attempt has been logged.",id:"SESSION_INTEGRITY_FAILED",title:"Session integrity validation failed",rationale:"Session integrity checks were missing or invalid.",timingMs:Date.now()-d})}return null}(a,c,u,t);if(B){let b=c.req?.auth;"deny"===B.verdict&&(C({identityId:b?.identityId,ipHash:b?.ipHash}),B.throttle=D({identityId:b?.identityId,ipHash:b?.ipHash})),B.findings=v(B.findings);let d=F(B);return H(a,c,d),d}let E=v(function(a,b,c){let d=[...a].sort((a,b)=>a.order-b.order||a.id.localeCompare(b.id)),e=[];for(let a of d){let d=a.detect(b,c);d&&d.length&&e.push(...d)}return e}([{id:"BASE_INTRUSION_LANGUAGE",order:10,detect:a=>{let b=l({text:a.text});return b&&m(b,n)?[k({id:"INTRUSION_INDICATOR",title:"Intrusion / override indicator detected",severity:"high",verdict:"deny",rationale:"Input contains language commonly associated with bypassing controls.",tags:["intrusion","baseline"]})]:[]}},{id:"BASE_EXFIL_LANGUAGE",order:20,detect:a=>{let b=l({text:a.text});return b&&m(b,o)?[k({id:"EXFIL_INDICATOR",title:"Potential data exfiltration intent detected",severity:"high",verdict:"deny",rationale:"Input suggests an attempt to obtain sensitive credentials or restricted data.",tags:["exfil","baseline"]})]:[]}},{id:"BASE_PRIV_ESC_LANGUAGE",order:30,detect:a=>{let b=l({text:a.text});return b&&m(b,q)?[k({id:"PRIV_ESC_INDICATOR",title:"Privilege escalation indicator detected",severity:"high",verdict:"deny",rationale:"Input indicates an attempt to access privileged operator/admin actions.",tags:["privilege","baseline"]})]:[]}},{id:"BASE_MALWARE_LANGUAGE",order:40,detect:a=>{let b=l({text:a.text});return b&&m(b,p)?[k({id:"MALWARE_INDICATOR",title:"Malicious content indicator detected",severity:"critical",verdict:"deny",rationale:"Input contains terms commonly associated with malware/exploit activity.",tags:["malware","baseline"]})]:[]}},{id:"BASE_PII_REVIEW",order:50,detect:a=>{let b=a.text||"",c=/\b[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}\b/i.test(b),d=/\b(\+?1[\s-]?)?(\(?\d{3}\)?[\s-]?)\d{3}[\s-]?\d{4}\b/.test(b);return c||d?[k({id:"PII_POSSIBLE",title:"Possible personal data detected",severity:"medium",verdict:"sanitize",rationale:"Input may contain personal contact information; redaction recommended.",tags:["pii","baseline"],evidence:c?"email-like pattern":"phone-like pattern"})]:[]}}],A.forDetection,b)),G=function(a){if(!a.length)return{verdict:"allow",severity:"low"};let b="low",c="allow";for(let d of a)r[d.severity]>r[b]&&(b=d.severity),s[d.verdict]>s[c]&&(c=d.verdict);return{verdict:c,severity:b}}(E),I="deny"===G.verdict?3:"review"===G.verdict?2:+("sanitize"===G.verdict),J=c.req?.auth?.identityId;"deny"===G.verdict&&J&&b.escalationEnabled&&(i=function(a,b,c=Date.now()){let d=w.get(a),e={identityId:a,strikes:(d?.strikes??0)+1,lastSeverity:b,lastSeen:c,lockedUntil:d?.lockedUntil};return w.set(a,e),e}(J,d=G.severity),I="critical"===d?(x(J,36e5),5):i.strikes>=3?(x(J,9e5),4):2===i.strikes?3:2);let K=function(a,b){let c=[];for(let d of b){if("sanitize"!==d.verdict)continue;let b=/\b[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}\b/gi;for(let d of a.matchAll(b)){let a=d.index??-1;a>=0&&c.push({start:a,end:a+d[0].length,label:"PII"})}let e=/\b(\+?1[\s-]?)?(\(?\d{3}\)?[\s-]?)\d{3}[\s-]?\d{4}\b/g;for(let b of a.matchAll(e)){let a=b.index??-1;a>=0&&c.push({start:a,end:a+b[0].length,label:"PII"})}}return c}(c.text,E),L=("sanitize"===G.verdict||"review"===G.verdict)&&K.length?function(a,b){if(!b.length)return a;let c=function(a){let b=[...a].sort((a,b)=>a.start-b.start||a.end-b.end),c=[];for(let a of b){let b=c[c.length-1];!b||a.start>b.end?c.push({...a}):(b.end=Math.max(b.end,a.end),b.label=b.label||a.label)}return c}(b),d="",e=0;for(let b of c)d+=a.slice(e,b.start),d+=`[REDACTED:${b.label}]`,e=b.end;return d+a.slice(e)}(c.text,K):void 0,M={verdict:G.verdict,severity:G.severity,findings:E,redactions:K.length?K:void 0,safeText:L,traceId:u,timingMs:Date.now()-t,enforcementLevel:I,publicMessage:"deny"===(e={verdict:G.verdict,enforcementLevel:I}).verdict?e.enforcementLevel>=4?"Access revoked temporarily due to policy violations. Contact an authorized administrator.":"Request denied: unauthorized or unsafe operation. This attempt has been logged.":"review"===e.verdict?"Request restricted by policy. Additional authorization is required.":void 0};if("deny"===M.verdict&&(C({identityId:J,ipHash:c.req?.auth?.ipHash}),M.throttle=D({identityId:J,ipHash:c.req?.auth?.ipHash})),5===M.enforcementLevel&&b.incidentOnCritical){let b=(f={identityId:J,sessionId:c.req?.auth?.sessionId,ipHash:c.req?.auth?.ipHash},{traceId:M.traceId,occurredAt:Date.now(),identityId:f?.identityId,sessionId:f?.sessionId,ipHash:f?.ipHash,enforcementLevel:M.enforcementLevel??0,verdict:M.verdict,severity:M.severity,findingsSummary:(M.findings??[]).map(a=>({id:a.id,severity:a.severity,verdict:a.verdict}))});try{a.store?.appendIncident?.(b).catch(()=>{})}catch{}}let N=F(M);return H(a,c,N),N}}}class J{async appendAudit(a){this.audits.push(a)}async appendEvent(a){this.events.push(a)}async getRecentAudits(a){return this.audits.slice().sort((a,b)=>b.at-a.at).slice(0,Math.max(1,Math.min(200,a)))}async appendIncident(a){this.incidents.push(a)}async getRecentIncidents(a){return this.incidents.slice().sort((a,b)=>b.occurredAt-a.occurredAt).slice(0,Math.max(1,Math.min(200,a)))}async getIncidentByTrace(a){return this.incidents.find(b=>b.traceId===a)??null}constructor(){this.audits=[],this.events=[],this.incidents=[]}}let K="bane_audits",L="bane_incidents";function M(a){return Array.isArray(a)?a:[]}class N{constructor(a){this.db=a}async appendAudit(a){let b=this.db.collection(K).doc();await b.set({...a,id:b.id??void 0},{merge:!1})}async appendEvent(a){let b=this.db.collection("bane_events").doc();await b.set({...a,id:b.id??void 0},{merge:!1})}async getRecentAudits(a){let b=this.db.collection(K).orderBy?.("at","desc").limit?.(a),c=await (b??this.db.collection(K)).get();return M(c?.docs??[]).map(a=>a.data())}async appendIncident(a){let b=this.db.collection(L).doc();await b.set({...a,id:b.id??void 0},{merge:!1})}async getRecentIncidents(a){let b=this.db.collection(L).orderBy?.("occurredAt","desc").limit?.(a),c=await (b??this.db.collection(L)).get();return M(c?.docs??[]).map(a=>a.data())}async getIncidentByTrace(a){let b=this.db.collection(L).where?.("traceId","==",a).limit?.(1),c=await (b??this.db.collection(L)).get(),d=M(c?.docs??[]);return d.length?d[0].data():null}}let O={profileId:"bane_fog_v1",store:function(){try{let a=(function(){if(e)return e;let a=function(){if(d)return d;let a=(0,eval)("require")("firebase-admin");return d=a?.default??a}();return a.apps&&0!==a.apps.length||a.initializeApp(),e=a.app()})().firestore();return new N(a)}catch{return new J}}()},P=(f=I(O),function(a){let b={text:a.bodyText??"",req:{route:a.path??"http:unknown",requiredCapability:"bane:invoke",auth:{identityId:a.identityId,sessionId:a.sessionId,ipHash:a.ipHash,capabilities:a.capabilities,isAuthenticated:!!a.identityId,sessionIntegrity:a.sessionIntegrity}}},c=f.evaluate(b);return"deny"===c.verdict?{ok:!1,status:4===c.enforcementLevel?423:(c.enforcementLevel,403),message:c.publicMessage??"Access denied by policy.",traceId:c.traceId,retryAfterMs:c.throttle&&"block"===c.throttle.action?c.throttle.retryAfterMs:void 0}:"review"===c.verdict?{ok:!1,status:401,message:c.publicMessage??"Additional authorization required.",traceId:c.traceId}:{ok:!0,traceId:c.traceId}});I(O)}};